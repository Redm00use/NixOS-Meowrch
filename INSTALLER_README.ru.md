# Meowrch NixOS Advanced Installer (Русская версия руководства)

Этот файл — подробное руководство по использованию установщика `install.sh`, входящего в состав проекта **Meowrch NixOS**.  
Цель — сделать процесс настройки системы на базе NixOS максимально автоматизированным и дружелюбным к новичкам.

---

## Оглавление

1. Что делает установщик  
2. Быстрый старт (один пользователь)  
3. Режим нескольких пользователей  
4. Ключевые идеи и принципы  
5. Генерация hardware-configuration.nix  
6. Список флагов (полная справка)  
7. Примеры запуска  
8. Логи и где их искать  
9. Структура репозитория (важные файлы)  
10. Типовые сценарии использования  
11. Фаза валидации (validate-config.sh)  
12. Режим сухого прогона (dry-run)  
13. JSON режим  
14. Безопасность и замечания  
15. Частые проблемы и их решения  
16. FAQ  
17. Термины (глоссарий)  
18. Как улучшить и внести вклад  
19. Лицензия / повторное использование  
20. Краткая памятка  

---

## 1. Что делает установщик

Скрипт `install.sh` автоматизирует:

- Создание **основного (primary)** пользователя + дополнительных (опционально).
- Патчинг `configuration.nix` и `home/home.nix` под основного пользователя.
- Нормализацию жёстко прописанных путей (например `/home/meowrch/...`).
- Генерацию `hardware-configuration.nix` (если отсутствует или запрошено пересоздание).
- Запуск проверки конфигурации (если есть `validate-config.sh`).
- Сборку системы через `nixos-rebuild switch`.
- Применение Home Manager для основного пользователя.
- Инициализацию git-репозитория и коммит изменений (если не было).
- Формирование логов, сводки и (если нужно) JSON-вывода.
- Поддержку повторных безопасных запусков (идемпотентность).

---

## 2. Быстрый старт (один пользователь)

Минимальный запуск:

```bash
./install.sh --user meowrch \
  --full-name "Meowrch User" \
  --email user@example.com \
  --git-name "Meowrch User"
```

После завершения:

```bash
sudo passwd meowrch
sudo reboot
```

Рабочая копия конфигурации будет в:

```
/home/meowrch/meowrch-nixos
```

---

## 3. Режим нескольких пользователей

Можно создать сразу несколько пользователей:

```bash
./install.sh \
  --user-spec "alice,Alice Wonderland,alice@example.org,Alice W." \
  --user-spec "bob,Bob Builder,bob@example.net,Bob B."
```

Формат `--user-spec`:

```
username[,Полное имя[,Email[,Git Name]]]
```

- Первый указанный пользователь = **основной** (primary).
- Для него выполняется патчинг flake-конфигов и Home Manager.
- Остальные просто добавляются в систему (группы + домашняя директория).

Если не указывать никого — будет использован дефолтный пользователь (meowrch).

---

## 4. Ключевые идеи и принципы

- **Primary user** — интегрируется в NixOS + Home Manager.
- **Дополнительные** — системные (при желании позже можно включить во flake).
- **Идемпотентность** — повторный запуск не ломает конфиги.
- **Явность** — никаких скрытых магий: логи, dry-run, JSON помогают понять процесс.
- **Гибкость** — можно пропустить этапы (--no-build, --no-home-manager и т.д.).

---

## 5. Генерация hardware-configuration.nix

- Если файла нет — создаётся автоматически (кроме `--no-hardware`).
- Принудительное пересоздание: `--regenerate-hardware`.
- Рекомендуется не коммитить в git (по умолчанию игнорируется), чтобы конфиг оставался переносимым.
- При изменении дисковой разметки — пересоздайте.

---

## 6. Список флагов (полная справка)

Пользователи и идентичность:
- `--user NAME` — основной пользователь (лаконичный способ).
- `--full-name "Имя"` / `--email email@` / `--git-name "Git Автор"` — для основного.
- `--user-spec "u[,Имя[,Email[,Git]]]"`
- `--hostname HOST` — пропатчить hostName в модуле сети.
- `--state-version X.YY` — выставить system.stateVersion / home.stateVersion (по умолчанию 25.05).
- `--flake-host ATTR` — flake-атрибут системы (по умолчанию meowrch).

Поведение:
- `--no-build` — не собирать систему.
- `--no-home-manager` — не применять Home Manager.
- `--no-hardware` — не генерировать hardware-configuration.nix.
- `--regenerate-hardware` — пересоздать hardware-configuration.nix.
- `--no-backup` — пропустить бэкап.
- `--fast` — пропустить validate-config.sh.
- `--impure` — добавить `--impure` к `nixos-rebuild`.
- `--dry-run` — показать, что будет сделано (без изменений).
- `--json` — JSON-отчёт в конце.
- `--quiet` — минимальные логи.
- `--log-file PATH` — явный файл логов.
- `--log-dir DIR` — каталог логов (по умолчанию ./logs).
- `--log-stderr-separate` — отдельный файл ошибок.
- `--generate-installer-readme` — создать/обновить INSTALLER_README.
- `--force` — продолжить не на NixOS (не рекомендуется).
- `--help` — помощь.

---

## 7. Примеры запуска

Обычная установка:

```bash
./install.sh --user gamer --full-name "Pro Gamer" --email gamer@host
```

Мульти-режим:

```bash
./install.sh \
  --user-spec "dev,Dev User,dev@host,Dev U." \
  --user-spec "ops,Ops User,ops@host,Ops O."
```

Dry-run:

```bash
./install.sh --user test --dry-run
```

Без сборки:

```bash
./install.sh --user meowrch --no-build --no-home-manager
```

JSON отчёт:

```bash
./install.sh --user meowrch --json --no-build
```

Пересоздать hardware-конфиг:

```bash
./install.sh --user meowrch --regenerate-hardware
```

С тихим логированием:

```bash
./install.sh --user meowrch --quiet --log-dir /tmp/inst-logs
```

---

## 8. Логи и где их искать

- По умолчанию — каталог `./logs/`.
- Последний запуск: симлинк `logs/latest-install.log`.
- Можно задать другой каталог через `--log-dir`.
- Отдельный stderr: `--log-stderr-separate`.
- В режиме `--json` можно парсить итоговую сводку автоматически.

---

## 9. Структура репозитория (частично)

```
install.sh                    # Установщик
configuration.nix             # Основной системный конфиг
home/home.nix                 # Home Manager конфиг основного пользователя
modules/system/*.nix          # Модули системы
modules/desktop/*.nix         # UI/десктоп части
packages/*.nix                # Кастомные пакеты
overlays/*.nix                # Оверлеи для nixpkgs
flake.nix / flake.lock        # Flake описание
INSTALLER_README.md           # EN версия
INSTALLER_README.ru.md        # RU версия (этот файл)
```

---

## 10. Типовые сценарии

1. **Чистая установка**:  
   - Клонируете репозиторий.  
   - Запускаете установщик с нужными флагами.  
   - Перезагрузка.  
2. **Добавить ещё пользователя позже**:  
   - Запускаете снова с `--user-spec "newuser,..."`.  
3. **Поменять hostname**:  
   - `./install.sh --user meowrch --hostname new-host`  
4. **Нужен только патч без rebuild**:  
   - `--no-build --no-home-manager`  
5. **Понять, что он сделает**:  
   - `--dry-run`  

---

## 11. Фаза валидации

Если существует `validate-config.sh` (исполняемый):
- Выполняется до сборки (если не указан `--fast`).
- Ошибка не прерывает процесс (для удобства новичков).
- Можно ужесточить поведение вручную (например, exit при ошибке).

---

## 12. Dry-Run режим

`--dry-run`:
- Ничего не записывает и не создаёт пользователей.
- Показывает потенциальные замены (sed, генерация, копирование).
- Очень полезно перед первым реальным запуском.

---

## 13. JSON режим

`--json` генерирует структурированный вывод:
- primary_user
- массив всех пользователей
- время выполнения
- summary (действия)
- errors (если есть)

Комбинируется с `--quiet` для машинной интеграции (CI).

---

## 14. Безопасность и замечания

- Не запускайте от root.
- Пользователь добавляется в группы: wheel, networkmanager, audio, video, ... (проверьте список для своих политик безопасности).
- Не храните секреты в открытых nix-файлах.
- `hardware-configuration.nix` не коммитьте — для переносимости.
- stateVersion не обновляйте при каждом релизе — она фиксирует начальное состояние.

---

## 15. Частые проблемы и решения

| Проблема | Причина | Решение |
|----------|---------|---------|
| build failed | Ошибка nix выражений | `nixos-rebuild switch --flake .#meowrch` и читайте верх стека |
| home-manager не найден | Не установлен или не в inputs | Убедитесь во flake: `home-manager` подключён |
| hardware файл старый | Менялась разметка дисков | `--regenerate-hardware` |
| Пользователь уже существует | Повторный запуск | Это нормально, будет использован повторно |
| validate не сработал | Нет файла | Можно создать собственный скрипт |

---

## 16. FAQ

**Q:** Нужно ли обновлять `system.stateVersion` при каждом релизе?  
**A:** Нет. Оставляйте ту, с которой началась система, иначе могут измениться дефолтные поведенческие параметры.

**Q:** Зачем `--impure`?  
**A:** Только если у вас есть выражения, зависящие от внешнего окружения/импорта вне flake.

**Q:** Можно ли автоматически добавить всех пользователей в flake?  
**A:** Скрипт этого не делает специально (чтобы не усложнять новичкам). Можно вручную отредактировать `configuration.nix`.

**Q:** Где посмотреть актуальный лог?  
**A:** `logs/latest-install.log`.

**Q:** Безопасно ли многократно запускать?  
**A:** Да. Изменения патчатся аккуратно, git фиксирует дельту.

---

## 17. Термины (глоссарий)

- **Flake** — формат организации декларативной конфигурации Nix/NixOS.
- **Primary user** — основной пользователь, интегрированный в конфиги.
- **Idempotent** — повторный запуск не наносит вреда состоянию.
- **Home Manager** — модульная система управления окружением пользователя.
- **hardware-configuration.nix** — автоматически сгенерированные настройки оборудования.

---

## 18. Как улучшить и внести вклад

Идеи:
- Автоматическая генерация нескольких host-профилей.
- Добавление per-user home-manager интеграции.
- Интеграция секретов (sops / agenix).
- Дополнительные проверки: поиск устаревших опций.
- Добавление тестов (nix flake check расширить).

Процесс:
1. Форк / ветка.
2. Изменения.
3. `./install.sh --dry-run --json` для проверки.
4. Коммит и PR.

---

## 19. Лицензия / повторное использование

Если не указано иное — рассматривать как свободно используемый материал (публичный стиль).  
Приветствуется обратный вклад (patch / PR / улучшение документации).

---

## 20. Краткая памятка (Cheat Sheet)

| Задача | Команда |
|--------|---------|
| Установка (один пользователь) | `./install.sh --user meowrch --email user@ex` |
| Несколько пользователей | `./install.sh --user-spec "a,A" --user-spec "b,B"` |
| Dry-run | `./install.sh --user meowrch --dry-run` |
| Пропустить сборку | `./install.sh --user meowrch --no-build` |
| Генерация README установщика | `./install.sh --generate-installer-readme` |
| Пересоздать hardware | `./install.sh --user meowrch --regenerate-hardware` |
| JSON отчёт | `./install.sh --user meowrch --json` |
| Тихий режим | `./install.sh --user meowrch --quiet` |
| Логи в custom каталог | `./install.sh --user m --log-dir /tmp/logs` |
| Применить только Home Manager (после) | `home-manager switch --flake .#meowrch` |
| Ручная пересборка | `sudo nixos-rebuild switch --flake .#meowrch` |

---

### Удачной работы с NixOS и Meowrch! 🐾  
Если есть предложения — расширяйте файл или отправляйте изменения в репозиторий.